---
typora-root-url: img
---

# Flinkèµ„æºç®¡ç†æœºåˆ¶

[TOC]



## 1 åŸºæœ¬æ¦‚å¿µ

### 1.1 ç›¸å…³ç»„ä»¶

Flink èµ„æºç®¡ç†ç›¸å…³çš„ç»„ä»¶ï¼š

* ä¸€ä¸ªFlink Cluster æ˜¯ç”±ä¸€ä¸ª Flink Master å’Œå¤šä¸ª Task Manager ç»„æˆçš„
* Master å’Œ TaskManager æ˜¯è¿›ç¨‹çº§ç»„ä»¶

å…¶ä»–çš„ç»„ä»¶éƒ½æ˜¯è¿›ç¨‹å†…çš„ç»„ä»¶

![img](flink0001)

å¦‚å›¾ï¼š

* ä¸€ä¸ª Flink Master ä¸­æœ‰ä¸€ä¸ª Resource Manager å’Œå¤šä¸ª Job Manager
* Flink Master ä¸­æ¯ä¸ª JobManager éƒ½**å•ç‹¬ç®¡ç†**ä¸€ä¸ªå…·ä½“çš„ Job
* Job Manager ä¸­çš„ Scheduler ç»„ä»¶è´Ÿè´£è°ƒåº¦æ‰§è¡Œè¯¥ Job çš„ DAG ä¸­æ‰€æœ‰ Task å‘å‡ºèµ„æºè¯·æ±‚ï¼Œå³**æ•´ä¸ªèµ„æºè°ƒåº¦çš„èµ·ç‚¹**
* Job Manager ä¸­çš„ Slot Pool ç»„ä»¶æŒæœ‰åˆ†é…åˆ°**è¯¥ Job** çš„æ‰€æœ‰èµ„æº
* å¦å¤–ï¼ŒFlink Master ä¸­å”¯ä¸€çš„ Resource Manager è´Ÿè´£æ•´ä¸ª Flink Cluster çš„èµ„æºè°ƒåº¦ä»¥åŠä¸å¤–éƒ¨è°ƒåº¦ç³»ç»Ÿ**å¯¹æ¥**ï¼ˆå¤–éƒ¨ç³»ç»Ÿï¼šKubernetesã€Mesosã€Yarnç­‰èµ„æºç®¡ç†ç³»ç»Ÿï¼‰

TaskManager è´Ÿè´£ Task çš„æ‰§è¡Œï¼Œå…¶ä¸­ Slot æ˜¯ TaskManager èµ„æºçš„ä¸€ä¸ªå­é›†ï¼Œä¹Ÿæ˜¯ Flink èµ„æºç®¡ç†çš„ä¸€ä¸ªåŸºæœ¬å•ä½ã€‚

Slot çš„æ¦‚å¿µè´¯ç©¿æ•´ä¸ªèµ„æºè°ƒåº¦çš„è¿‡ç¨‹ã€‚

### 1.2 é€»è¾‘å±‚çº§

ç»„ä»¶ä¹‹é—´çš„é€»è¾‘å…³ç³»ï¼Œå…±åˆ†ä¸º4å±‚

* Operator
  * ç®—å­æ˜¯æœ€åŸºæœ¬çš„æ•°æ®å¤„ç†å•å…ƒ
  * å¦‚æœä¸¤ä¸ªOperatorå±äºåŒä¸€ä¸ªTaskï¼Œé‚£ä¹ˆä¸ä¼šå‡ºç°ä¸€ä¸ªOperatorå·²ç»å¼€å§‹è¿è¡Œå¦ä¸€ä¸ªOperatorè¿˜æ²¡è¢«è°ƒåº¦çš„æƒ…å†µ
* Task
  * Flink Runtime ä¸­çœŸæ­£å»è¿›è¡Œè°ƒåº¦çš„æœ€å°å•ä½
  * ç”±ä¸€ç³»åˆ—ç®—å­é“¾ç»„æˆï¼ˆchained operatorsï¼‰
* Job
  * å¯¹åº”ä¸€ä¸ª Job Graph
* Cluster
  * 1 Flink Master + N Task Manager

![img](flink0002)

èµ„æºè°ƒåº¦çš„èŒƒç•´ï¼Œå®é™…ä¸Šæ˜¯å›¾ä¸­çº¢æ¡†ä¸­çš„å†…å®¹

- JobManager ( Secheduler å’Œ Slot Pool) å¯¹åº”äº Job
- Resource Manager ( Slot Manager ) å’Œ Task Manager å¯¹åº”äº Flink Cluster çº§åˆ«

- åœ¨ Operator å’Œ Task ä¸­é—´çš„ Chaining æ˜¯æŒ‡å¦‚ä½•ç”¨ Operator ç»„æˆ Taskã€‚
- åœ¨ Task å’Œ Job ä¹‹é—´çš„ Slot Sharing æ˜¯æŒ‡å¤šä¸ª Task å¦‚ä½•å…±äº«ä¸€ä¸ª Slot èµ„æºï¼Œè¿™ç§æƒ…å†µä¸ä¼šå‘ç”Ÿåœ¨è·¨ä½œä¸šçš„æƒ…å†µä¸­
- Flink Cluster å’Œ Job ä¹‹é—´çš„ Slot Allocation æ˜¯æŒ‡ Flink Cluster ä¸­çš„ Slot æ˜¯æ€æ ·åˆ†é…ç»™ä¸åŒçš„ Job

### 1.3 ä¸¤å±‚èµ„æºè°ƒåº¦æ¨¡å‹

Flink èµ„æºè°ƒåº¦æ˜¯ä¸€ä¸ªç»å…¸çš„ä¸¤å±‚æ¨¡å‹ï¼Œ

- å…¶ä¸­ä» Cluster åˆ° Job çš„åˆ†é…è¿‡ç¨‹æ˜¯ç”± Slot Manager æ¥å®Œæˆ
- Job å†…éƒ¨åˆ†é…ç»™Taskèµ„æºçš„è¿‡ç¨‹æ˜¯ç”± Scheduler æ¥å®Œæˆ

å¦‚å›¾: Scheduler å‘ Slot pool å‘å‡º Slot Requestï¼ˆèµ„æºè¯·æ±‚ï¼‰ï¼ŒSlot Pool å¦‚æœä¸èƒ½æ»¡è¶³è¯¥èµ„æºéœ€æ±‚åˆ™ä¼šè¿›ä¸€æ­¥è¯·æ±‚ Resource Managerï¼Œå…·ä½“æ¥æ»¡è¶³è¯¥è¯·æ±‚çš„ç»„ä»¶æ˜¯ Slot Manager

![img](flink0003)

Task å¯¹ Slot è¿›è¡Œå¤ç”¨æœ‰ä¸¤ç§æ–¹å¼ï¼š

- Slot Caching

- - æ‰¹å¤„ç†
  - æµå¤„ç†çš„ Failover
  - å¤šä¸ª Task å…ˆå/è½®æµä½¿ç”¨ Slot èµ„æº

- Slot Sharing

  - å¤šä¸ª Task åœ¨æ»¡è¶³ä¸€å®šæ¡ä»¶ä¸‹åŒæ—¶å…±äº«åŒä¸€ä¸ª Slot èµ„æº



## 2 å½“å‰æœºåˆ¶ä¸ç­–ç•¥

### 2.1 TaskManageræœ‰å“ªäº›èµ„æº

![img](flink0004)

â€‹																				<!--TaskManagerèµ„æºç»„æˆ-->

- èµ„æºç±»å‹

- - GPUï¼ˆFLIP-108ï¼Œåœ¨Flink1.11ç‰ˆæœ¬å®Œæˆï¼‰
  - å†…å­˜
  - CPU
  - å…¶ä»–æ‰©å±•èµ„æº

- Task Manager èµ„æºç”±é…ç½®å†³å®š

- - Standalone éƒ¨ç½²æ¨¡å¼ä¸‹ï¼ŒTM èµ„æºå¯èƒ½ä¸åŒ
  - å…¶ä»–éƒ¨ç½²æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰ TM èµ„æºå‡ç›¸åŒ

### 2.2 Slot æœ‰å“ªäº›èµ„æº

![img](flink0005)

â€‹																			<!--Slotèµ„æºç»„æˆ-->

Task Manager ä¸­æœ‰å›ºå®šæ•°é‡çš„ Slotï¼ŒSlot çš„å…·ä½“æ•°é‡ç”±é…ç½®å†³å®šï¼ŒåŒä¸€ TaskManager ä¸Š Slot ä¹‹é—´æ²¡æœ‰å·®åˆ«ï¼Œæ¯ä¸€ä¸ª Slot éƒ½ä¸€æ ·å¤§ï¼Œå³èµ„æºä¸€æ ·å¤š

### 2.3 Flink Cluster æœ‰å¤šå°‘ Task Manager

- Standalone éƒ¨ç½²æ¨¡å¼

åœ¨Standaloneéƒ¨ç½²æ¨¡å¼ä¸‹ï¼ŒTask Managerçš„æ•°é‡æ˜¯å›ºå®šçš„ï¼Œå¦‚æœ start-Cluster.sh è„šæœ¬æ¥å¯åŠ¨é›†ç¾¤ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ä»¥ä¸‹æ–‡ä»¶ä¸­çš„é…ç½®æ¥å†³å®šTMçš„æ•°é‡ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ‰‹åŠ¨æ‰§è¡Œ Taskmanager.sh è„šæœ¬æ¥å¯åŠ¨ä¸€ä¸ª TMã€‚`<FLINK_DIR>/conf/slaves`

- Active Resource manager éƒ¨ç½²æ¨¡å¼

- - å½“å‰ Slot æ•°é‡ä¸èƒ½æ»¡è¶³æ–°çš„ Slot Request æ—¶ï¼Œç”³è¯·å¹¶å¼€å¯æ–°çš„ Task manager
  - TaskManager ç©ºé—²ä¸€æ®µæ—¶é—´åï¼Œè¶…æ—¶åˆ™é‡Šæ”¾
  - Kubernetesï¼ŒYarnï¼ŒMesos
  - ç”± SlotManager / ResourceManager æŒ‰éœ€åŠ¨æ€å†³å®š

On-Yarn éƒ¨ç½²æ¨¡å¼ä¸å†æ”¯æŒæŒ‡å®šå›ºå®šæ•°é‡çš„ TMï¼Œå³ä»¥ä¸‹å‘½ä»¤å‚æ•°å·²ç»å¤±æ•ˆ

```
yarn-session.sh -n <num>
flink run -yn <num>
```

### 2.4 Cluster -> Jobèµ„æºè°ƒåº¦çš„è¿‡ç¨‹

![img](flink0006)

â€‹																	<!-- Cluster åˆ° Job çš„èµ„æºè°ƒåº¦è¿‡ç¨‹ -->

Cluster åˆ° Job çš„èµ„æºè°ƒåº¦è¿‡ç¨‹ä¸­ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªè¿‡ç¨‹ã€‚

- Slot Allocationï¼ˆçº¢ç®­å¤´ï¼‰

Scheduler å‘ Slot Pool å‘é€è¯·æ±‚ï¼Œå¦‚æœ Slot èµ„æºè¶³å¤Ÿåˆ™ç›´æ¥åˆ†é…ï¼Œå¦‚æœ Slot èµ„æºä¸å¤Ÿï¼Œåˆ™ç”± Slot pool å†å‘ Slot Manager å‘é€è¯·æ±‚ï¼ˆæ­¤æ—¶å³ä¸º Job å‘ Cluster è¯·æ±‚èµ„æºï¼‰ï¼Œå¦‚æœ Slot Manager åˆ¤æ–­é›†ç¾¤å½“ä¸­æœ‰è¶³å¤Ÿçš„èµ„æºå¯ä»¥æ»¡è¶³éœ€æ±‚ï¼Œé‚£ä¹ˆå°±ä¼šå‘ Task Manager å‘é€ Assign æŒ‡ä»¤ï¼ŒTask Manager å°±ä¼šæä¾› Slot ç»™ Slot Poolï¼ŒSlot Pool å†å»æ»¡è¶³ Scheduler çš„èµ„æºè¯·æ±‚

- Starting TaskManagersï¼ˆè“ç®­å¤´ï¼‰

åœ¨ Active Resource Manager èµ„æºéƒ¨ç½²æ¨¡å¼ä¸‹ï¼Œå½“ Resource Manager åˆ¤å®š Flink Cluster ä¸­æ²¡æœ‰è¶³å¤Ÿçš„èµ„æºå»æ»¡è¶³éœ€æ±‚æ—¶ï¼Œå®ƒä¼šè¿›ä¸€æ­¥å»åº•å±‚çš„èµ„æºè°ƒåº¦ç³»ç»Ÿè¯·æ±‚èµ„æºï¼Œç”±è°ƒåº¦ç³»ç»ŸæŠŠæ–°çš„ Task Manager å¯åŠ¨èµ·æ¥ï¼Œå¹¶ä¸” TaskManager å‘ Resource Manager æ³¨å†Œï¼Œåˆ™å®Œæˆäº†æ–° Slot çš„è¡¥å……

### 2.5 Job -> Task èµ„æºè°ƒåº¦çš„è¿‡ç¨‹

- Scheduler

- - æ ¹æ® Execution Graph å’Œ Task çš„æ‰§è¡ŒçŠ¶æ€ï¼Œå†³å®šæ¥ä¸‹æ¥è¦è°ƒåº¦çš„ Task
  - å‘èµ· SlotRequest
  - å†³å®š Task / Slot ä¹‹é—´çš„åˆ†é…

- Slot Sharing

- - è¿è¡Œä¸€ä¸ªä½œä¸šæ‰€éœ€çš„ Slot æ•°é‡ä¸ºæœ€å¤§å¹¶å‘æ•°
  - ç›¸å¯¹è´Ÿè½½å‡è¡¡
  - é»˜è®¤æ‰€æœ‰èŠ‚ç‚¹åœ¨ä¸€ä¸ª Slot Sharing Group ä¸­
  - ä¸€ä¸ª Slot ä¸­ç›¸åŒä»»åŠ¡åªèƒ½æœ‰ä¸€ä¸ª
  - Slot Sharing Group ä¸­çš„ä»»åŠ¡å¯å…±ç”¨ Slot

![img](flink0007)

â€‹																<!--Jobåˆ°Taskèµ„æºè°ƒåº¦è¿‡ç¨‹-->

Slot Sharing  è¿‡ç¨‹å¦‚ä¸Šå›¾ ğŸ‘† æ‰€ç¤ºï¼ˆæ¯ä¸€è¡Œåˆ†åˆ«æ˜¯ä¸€ä¸ª Task çš„å¤šä¸ªå¹¶å‘ï¼Œè‡ªä¸‹è€Œä¸Šåˆ†åˆ«æ˜¯ Aã€Bã€Cï¼‰ï¼ŒAã€Bã€C çš„å¹¶è¡Œåº¦åˆ†åˆ«æ˜¯4ã€4ã€3ï¼Œè¿™äº› Task å±äºåŒä¸€ä¸ª Slot Sharing Group ä¸­ï¼Œæ‰€ä»¥ä¸åŒçš„ Task å¯ä»¥æ”¾åœ¨ç›¸åŒçš„ Slot ä¸­è¿è¡Œï¼Œå¦‚ä¸Šå›¾å³ä¾§æ‰€ç¤ºï¼Œæœ‰3ä¸ª Slot æ”¾å…¥äº† ABCï¼Œè€Œç¬¬å››ä¸ª Slot æ”¾å…¥äº† AB ã€‚é€šè¿‡ä»¥ä¸Šè¿‡ç¨‹æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“æ¨ç®—å‡ºè¿™ä¸ª Job éœ€è¦çš„ Slot æ•°æ˜¯4ï¼Œä¹Ÿæ˜¯**æœ€å¤§å¹¶å‘æ•°**ã€‚

### **2.6  èµ„æºè°ƒä¼˜**

é€šè¿‡ä»¥ä¸Šä»‹ç»çš„æœºåˆ¶ï¼Œæˆ‘ä»¬å®¹æ˜“å‘ç°ï¼ŒFlink æ‰€é‡‡ç”¨çš„æ˜¯è‡ªé¡¶å‘ä¸‹çš„èµ„æºç®¡ç†ï¼Œæˆ‘ä»¬æ‰€é…ç½®çš„æ˜¯ Job æ•´ä½“çš„èµ„æºï¼Œè€Œ Flink é€šè¿‡ Slot Sharing æœºåˆ¶æ§åˆ¶ Slot çš„æ•°é‡å’Œè´Ÿè½½å‡è¡¡ï¼Œé€šè¿‡è°ƒæ•´ Task Manager / Slot çš„èµ„æºï¼Œä»¥é€‚åº”ä¸€ä¸ª Slot Sharing Group çš„èµ„æºéœ€æ±‚ã€‚Flink çš„èµ„æºç®¡ç†é…ç½®ç®€å•ï¼Œæ˜“ç”¨æ€§å¼ºï¼Œé€‚åˆæ‹“æ‰‘ç»“æ„ç®€å•æˆ–è§„æ¨¡è¾ƒå°çš„ä½œä¸šã€‚



> https://mp.weixin.qq.com/s/VEOtfvcX3itxMI3w9JuGmw